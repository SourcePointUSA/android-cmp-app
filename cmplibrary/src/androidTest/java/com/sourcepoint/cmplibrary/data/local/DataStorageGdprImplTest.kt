package com.sourcepoint.cmplibrary.data.local

import androidx.test.internal.runner.junit4.AndroidJUnit4ClassRunner
import androidx.test.platform.app.InstrumentationRegistry
import com.example.uitestutil.assertEquals
import com.example.uitestutil.assertTrue
import com.sourcepoint.cmplibrary.data.network.converter.JsonConverter
import com.sourcepoint.cmplibrary.data.network.converter.converter
import com.sourcepoint.cmplibrary.data.network.model.optimized.—ÅonsentStatus.GdprCS
import org.junit.Test
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4ClassRunner::class)
class DataStorageGdprImplTest {

    private val appContext by lazy { InstrumentationRegistry.getInstrumentation().targetContext }

    @Test
    fun clear_data_DataStorage() {
        val storage = DataStorageGdpr.create(appContext).apply { deleteGdprConsent() }

        storage.saveAuthId("auth")
        storage.saveGdpr("{\"type\":\"GDPR\"}")

        storage.getGdpr().assertEquals("{\"type\":\"GDPR\"}")

        storage.clearInternalData()

        /** clearInternalData DOES NOT delete these prefs */
        storage.getGdpr().assertEquals("{\"type\":\"GDPR\"}")
    }

    @Test
    fun tcData_test_type() {
        val storage = DataStorageGdpr.create(appContext).apply { deleteGdprConsent() }

        JsonConverter.converter.decodeFromString<GdprCS>(tcData).TCData!!.let { storage.tcData = it }

        storage.tcData.apply {
            // Boolean
            (get("IABTCF_EnableAdvertiserConsentMode") is Boolean).assertTrue()
            // Int
            (get("IABTCF_gdprApplies") is Int).assertTrue()
            (get("IABTCF_CmpSdkID") is Int).assertTrue()
            (get("IABTCF_CmpSdkVersion") is Int).assertTrue()
            (get("IABTCF_PolicyVersion") is Int).assertTrue()
            (get("IABTCF_PurposeOneTreatment") is Int).assertTrue()
            (get("IABTCF_UseNonStandardTexts") is Int).assertTrue()
            // String
            (get("IABTCF_PublisherCC") is String).assertTrue()
            (get("IABTCF_AddtlConsent") is String).assertTrue()
            (get("IABTCF_TCString") is String).assertTrue()
            (get("IABTCF_VendorConsents") is String).assertTrue()
            (get("IABTCF_VendorLegitimateInterests") is String).assertTrue()
            (get("IABTCF_PurposeConsents") is String).assertTrue()
            (get("IABTCF_PurposeLegitimateInterests") is String).assertTrue()
            (get("IABTCF_SpecialFeaturesOptIns") is String).assertTrue()
            (get("IABTCF_PublisherConsent") is String).assertTrue()
            (get("IABTCF_PublisherLegitimateInterests") is String).assertTrue()
            (get("IABTCF_PublisherCustomPurposesConsents") is String).assertTrue()
            (get("IABTCF_PublisherCustomPurposesLegitimateInterests") is String).assertTrue()
            (get("IABTCF_PublisherRestrictions2") is String).assertTrue()
            (get("IABTCF_PublisherRestrictions4") is String).assertTrue()
            (get("IABTCF_PublisherRestrictions7") is String).assertTrue()
            (get("IABTCF_PublisherRestrictions10") is String).assertTrue()
        }
    }

    private val tcData = """
        {
          "TCData": {
            "IABTCF_AddtlConsent": "1~899",
            "IABTCF_CmpSdkID": 6,
            "IABTCF_CmpSdkVersion": 2,
            "IABTCF_PolicyVersion": 4,
            "IABTCF_PublisherCC": "DE",
            "IABTCF_PurposeOneTreatment": 0,
            "IABTCF_UseNonStandardTexts": 0,
            "IABTCF_TCString": "CP6VGIAP6VGIAAGABCENAoEsAPCAAEAAAAYgASAAAAAAQAAACBAAIAJBAAEAEg4ACACQoABABIAA.YAAAAAAAAAAA",
            "IABTCF_VendorConsents": "000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "IABTCF_VendorLegitimateInterests": "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "IABTCF_PurposeConsents": "1111000010",
            "IABTCF_PurposeLegitimateInterests": "0100000000",
            "IABTCF_SpecialFeaturesOptIns": "11",
            "IABTCF_PublisherConsent": "00000000000",
            "IABTCF_PublisherLegitimateInterests": "00000000000",
            "IABTCF_PublisherCustomPurposesConsents": "00000000000",
            "IABTCF_PublisherCustomPurposesLegitimateInterests": "00000000000",
            "IABTCF_EnableAdvertiserConsentMode": true,
            "IABTCF_gdprApplies": 1,
            "IABTCF_PublisherRestrictions2": "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "IABTCF_PublisherRestrictions4": "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "IABTCF_PublisherRestrictions7": "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "IABTCF_PublisherRestrictions10": "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
          }
        }
    """.trimIndent()
}
